# This file was automatically generated by sbt-github-actions using the
# githubWorkflowGenerate task. You should add and commit this file to
# your git repository. It goes without saying that you shouldn't edit
# this file by hand! Instead, if you wish to make changes, you should
# change your sbt build configuration to revise the workflow description
# to meet your needs, then regenerate this file.

name: Continuous Integration

on:
  pull_request:
    branches: ['**']
  push:
    branches: ['**']

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


concurrency:
  group: ${{ github.workflow }} @ ${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build and Test
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]
        scala: [2.13, 3]
        java:
          - temurin@11
          - temurin@21
          - temurin@22
          - graal_22.3.3@11
          - graalvm@21
          - graalvm@22
          - semeru@11
          - semeru@21
          - semeru@22
        include:
          - os: macos-14
            java: temurin@22
            scala: 2.13
          - os: windows-latest
            java: temurin@22
            scala: 2.13
          - os: macos-14
            java: temurin@22
            scala: 3
          - os: windows-latest
            java: temurin@22
            scala: 3
        exclude:
          - os: windows-latest
            java: graal_22.3.3@11
          - os: windows-latest
            java: graalvm@21
          - os: windows-latest
            java: graalvm@22
          - os: windows-latest
            java: semeru@11
          - os: windows-latest
            java: semeru@21
          - os: windows-latest
            java: semeru@22
          - os: macos-14
            java: graal_22.3.3@11
          - os: macos-14
            java: graalvm@21
          - os: macos-14
            java: graalvm@22
          - os: macos-14
            java: semeru@11
          - os: macos-14
            java: semeru@21
          - os: macos-14
            java: semeru@22
          - os: macos-14
            java: temurin@11
          - os: macos-14
            java: temurin@21
          - os: macos-14
            java: temurin@22
          - os: windows-latest
            java: temurin@11
          - os: windows-latest
            java: temurin@21
          - os: windows-latest
            java: temurin@22
          - os: ubuntu-latest
            java: semeru@11
            scala: 3
          - os: ubuntu-latest
            java: graal_22.3.3@11
            scala: 3
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    steps:
      - name: Install sbt
        if: contains(runner.os, 'macos')
        shell: bash
        run: brew install sbt

      - name: Ignore line ending differences in git
        if: contains(runner.os, 'windows')
        shell: bash
        run: git config --global core.autocrlf false

      - name: Checkout current branch (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java (temurin@11)
        id: setup-java-temurin-11
        if: matrix.java == 'temurin@11'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11
          cache: sbt

      - name: sbt update
        if: matrix.java == 'temurin@11' && steps.setup-java-temurin-11.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v +update

      - name: Setup Java (temurin@21)
        id: setup-java-temurin-21
        if: matrix.java == 'temurin@21'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: sbt

      - name: sbt update
        if: matrix.java == 'temurin@21' && steps.setup-java-temurin-21.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v +update

      - name: Setup Java (temurin@22)
        id: setup-java-temurin-22
        if: matrix.java == 'temurin@22'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 22
          cache: sbt

      - name: sbt update
        if: matrix.java == 'temurin@22' && steps.setup-java-temurin-22.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v +update

      - name: Setup GraalVM (graal_22.3.3@11)
        id: setup-graalvm-22_3_3-11
        if: matrix.java == 'graal_22.3.3@11'
        uses: graalvm/setup-graalvm@v1
        with:
          version: 22.3.3
          java-version: 11
          cache: sbt

      - name: sbt update
        if: matrix.java == 'graal_22.3.3@11' && steps.setup-graalvm-22_3_3-11.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v +update

      - name: Setup Java (graalvm@21)
        id: setup-java-graalvm-21
        if: matrix.java == 'graalvm@21'
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: graalvm
          java-version: 21
          cache: sbt

      - name: sbt update
        if: matrix.java == 'graalvm@21' && steps.setup-java-graalvm-21.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v +update

      - name: Setup Java (graalvm@22)
        id: setup-java-graalvm-22
        if: matrix.java == 'graalvm@22'
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: graalvm
          java-version: 22
          cache: sbt

      - name: sbt update
        if: matrix.java == 'graalvm@22' && steps.setup-java-graalvm-22.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v +update

      - name: Setup Java (semeru@11)
        id: setup-java-semeru-11
        if: matrix.java == 'semeru@11'
        uses: actions/setup-java@v4
        with:
          distribution: semeru
          java-version: 11
          cache: sbt

      - name: sbt update
        if: matrix.java == 'semeru@11' && steps.setup-java-semeru-11.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v +update

      - name: Setup Java (semeru@21)
        id: setup-java-semeru-21
        if: matrix.java == 'semeru@21'
        uses: actions/setup-java@v4
        with:
          distribution: semeru
          java-version: 21
          cache: sbt

      - name: sbt update
        if: matrix.java == 'semeru@21' && steps.setup-java-semeru-21.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v +update

      - name: Setup Java (semeru@22)
        id: setup-java-semeru-22
        if: matrix.java == 'semeru@22'
        uses: actions/setup-java@v4
        with:
          distribution: semeru
          java-version: 22
          cache: sbt

      - name: sbt update
        if: matrix.java == 'semeru@22' && steps.setup-java-semeru-22.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v +update

      - name: Check that workflows are up to date
        shell: bash
        run: sbt -v githubWorkflowCheck

      - if: (!((matrix.java == 'semeru@11') || (matrix.java == 'semeru@21') || (matrix.java == 'semeru@22'))) && (!(contains(github.event.head_commit.message, 'full CI')))
        shell: bash
        run: sbt -v '++ ${{ matrix.scala }}' ci

      - if: (!((matrix.java == 'semeru@11') || (matrix.java == 'semeru@21') || (matrix.java == 'semeru@22'))) && (contains(github.event.head_commit.message, 'full CI'))
        shell: bash
        run: sbt -v '++ ${{ matrix.scala }}' ciFull

      - if: ((matrix.java == 'semeru@11') || (matrix.java == 'semeru@21') || (matrix.java == 'semeru@22')) && (!(contains(github.event.head_commit.message, 'full CI')))
        shell: bash
        run: 'sbt -v ''++ ${{ matrix.scala }}'' -J-Xgcpolicy:balanced ci'

      - if: ((matrix.java == 'semeru@11') || (matrix.java == 'semeru@21') || (matrix.java == 'semeru@22')) && (contains(github.event.head_commit.message, 'full CI'))
        shell: bash
        run: 'sbt -v ''++ ${{ matrix.scala }}'' -J-Xgcpolicy:balanced ciFull'

      - if: matrix.scala != '3'
        shell: bash
        run: sbt -v '++ ${{ matrix.scala }}' checkScalafix

      - if: ((matrix.os == 'macos-14') || ((matrix.os == 'ubuntu-latest') && (matrix.java == 'temurin@22'))) && ((contains(github.event.head_commit.message, 'full CI')) || (contains(github.event.head_commit.message, 'stressLinchk')))
        shell: bash
        run: sbt -v '++ ${{ matrix.scala }}' runLincheckTests

      - if: ((matrix.os == 'macos-14') || ((matrix.os == 'ubuntu-latest') && (matrix.java == 'temurin@22'))) && ((contains(github.event.head_commit.message, 'full CI')) || (contains(github.event.head_commit.message, 'stressMcas')))
        shell: bash
        run: sbt -v '++ ${{ matrix.scala }}' stressMcas/Jcstress/run

      - if: ((matrix.os == 'macos-14') || ((matrix.os == 'ubuntu-latest') && (matrix.java == 'temurin@22'))) && ((contains(github.event.head_commit.message, 'full CI')) || (contains(github.event.head_commit.message, 'stressCore')))
        shell: bash
        run: sbt -v '++ ${{ matrix.scala }}' stressCore/Jcstress/run

      - if: ((matrix.os == 'macos-14') || ((matrix.os == 'ubuntu-latest') && (matrix.java == 'temurin@22'))) && ((contains(github.event.head_commit.message, 'full CI')) || (contains(github.event.head_commit.message, 'stressData')))
        shell: bash
        run: sbt -v '++ ${{ matrix.scala }}' stressData/Jcstress/run

      - if: ((matrix.os == 'macos-14') || ((matrix.os == 'ubuntu-latest') && (matrix.java == 'temurin@22'))) && ((contains(github.event.head_commit.message, 'full CI')) || (contains(github.event.head_commit.message, 'stressExperiments')))
        shell: bash
        run: sbt -v '++ ${{ matrix.scala }}' stressExperiments/Jcstress/run

      - name: Upload JCStress results
        if: (success() || failure()) && ((matrix.os == 'macos-14') || ((matrix.os == 'ubuntu-latest') && (matrix.java == 'temurin@22'))) && (contains(github.event.head_commit.message, 'full CI') || (contains(github.event.head_commit.message, 'stressMcas') || contains(github.event.head_commit.message, 'stressCore') || contains(github.event.head_commit.message, 'stressData') || contains(github.event.head_commit.message, 'stressExperiments')))
        uses: actions/upload-artifact@v4
        with:
          name: jcstress-results-${{ matrix.os }}-${{ matrix.scala }}-${{ matrix.java }}
          path: results/
