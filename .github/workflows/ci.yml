# This file was automatically generated by sbt-github-actions using the
# githubWorkflowGenerate task. You should add and commit this file to
# your git repository. It goes without saying that you shouldn't edit
# this file by hand! Instead, if you wish to make changes, you should
# change your sbt build configuration to revise the workflow description
# to meet your needs, then regenerate this file.

name: Continuous Integration

on:
  pull_request:
    branches: ['**', '!update/**', '!pr/**']
  push:
    branches: ['**', '!update/**', '!pr/**']

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


concurrency:
  group: ${{ github.workflow }} @ ${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Test
    strategy:
      matrix:
        os:
          - ubuntu-24.04-arm
          - ubuntu-24.04
          - windows-2025
          - windows-11-arm
          - macos-15
          - macos-15-intel
        scala: [2.13, 3]
        java:
          - temurin@11
          - temurin@21
          - temurin@25
          - graalvm@21
          - graalvm@25
          - semeru@25
        ci: [ciJVM, ciJS, ciNative]
        include:
          - os: windows-2025
            java: temurin@25
            scala: 2.13
            ci: ciJS
          - os: ubuntu-24.04
            java: temurin@25
            scala: 2.13
            ci: ciNative
          - os: windows-11-arm
            java: temurin@21
            scala: 2.13
            ci: ciJVM
          - os: macos-15
            java: temurin@25
            scala: 2.13
            ci: ciNative
          - os: windows-2025
            java: temurin@25
            scala: 2.13
            ci: ciJVM
          - os: macos-15
            java: temurin@25
            scala: 2.13
            ci: ciJS
          - os: macos-15
            java: temurin@25
            scala: 2.13
            ci: ciJVM
          - os: macos-15-intel
            java: temurin@25
            scala: 2.13
            ci: ciJVM
          - os: macos-15-intel
            java: temurin@25
            scala: 2.13
            ci: ciNative
          - os: ubuntu-24.04
            java: temurin@25
            scala: 2.13
            ci: ciJVM
          - os: macos-15-intel
            java: temurin@25
            scala: 3
            ci: ciJVM
          - os: windows-2025
            java: temurin@25
            scala: 3
            ci: ciJS
          - os: windows-2025
            java: temurin@25
            scala: 3
            ci: ciJVM
          - os: windows-11-arm
            java: temurin@21
            scala: 3
            ci: ciJVM
          - os: ubuntu-24.04
            java: temurin@25
            scala: 3
            ci: ciJVM
          - os: macos-15
            java: temurin@25
            scala: 3
            ci: ciJS
          - os: macos-15
            java: temurin@25
            scala: 3
            ci: ciNative
          - os: ubuntu-24.04
            java: temurin@25
            scala: 3
            ci: ciNative
          - os: macos-15
            java: temurin@25
            scala: 3
            ci: ciJVM
          - os: macos-15-intel
            java: temurin@25
            scala: 3
            ci: ciNative
        exclude:
          - os: windows-2025
          - os: windows-11-arm
          - os: macos-15
          - os: macos-15-intel
          - os: ubuntu-24.04
          - java: graalvm@21
            scala: 3
          - java: temurin@21
            scala: 3
          - java: temurin@25
            scala: 2.13
            ci: ciJVM
          - java: temurin@11
            ci: ciJS
          - java: temurin@21
            ci: ciJS
          - java: graalvm@21
            ci: ciJS
          - java: graalvm@25
            ci: ciJS
          - java: semeru@25
            ci: ciJS
          - java: temurin@11
            ci: ciNative
          - java: graalvm@21
            ci: ciNative
          - java: graalvm@25
            ci: ciNative
          - java: semeru@25
            ci: ciNative
    runs-on: ${{ matrix.os }}
    timeout-minutes: 360
    steps:
      - name: Ignore line ending differences in git
        if: contains(runner.os, 'windows')
        shell: bash
        run: git config --global core.autocrlf false

      - name: Checkout current branch (full)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup sbt
        uses: sbt/setup-sbt@3e125ece5c3e5248e18da9ed8d2cce3d335ec8dd

      - name: Setup Java (temurin@11)
        id: setup-java-temurin-11
        if: matrix.java == 'temurin@11'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: temurin
          java-version: 11
          cache: sbt

      - name: sbt update
        if: matrix.java == 'temurin@11' && steps.setup-java-temurin-11.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Setup Java (temurin@21)
        id: setup-java-temurin-21
        if: matrix.java == 'temurin@21'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: temurin
          java-version: 21
          cache: sbt

      - name: sbt update
        if: matrix.java == 'temurin@21' && steps.setup-java-temurin-21.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Setup Java (temurin@25)
        id: setup-java-temurin-25
        if: matrix.java == 'temurin@25'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: temurin
          java-version: 25
          cache: sbt

      - name: sbt update
        if: matrix.java == 'temurin@25' && steps.setup-java-temurin-25.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Setup Java (graalvm@21)
        id: setup-java-graalvm-21
        if: matrix.java == 'graalvm@21'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: graalvm
          java-version: 21
          cache: sbt

      - name: sbt update
        if: matrix.java == 'graalvm@21' && steps.setup-java-graalvm-21.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Setup Java (graalvm@25)
        id: setup-java-graalvm-25
        if: matrix.java == 'graalvm@25'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: graalvm
          java-version: 25
          cache: sbt

      - name: sbt update
        if: matrix.java == 'graalvm@25' && steps.setup-java-graalvm-25.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Setup Java (semeru@25)
        id: setup-java-semeru-25
        if: matrix.java == 'semeru@25'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: semeru
          java-version: 25
          cache: sbt

      - name: sbt update
        if: matrix.java == 'semeru@25' && steps.setup-java-semeru-25.outputs.cache-hit == 'false'
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Check that workflows are up to date
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true githubWorkflowCheck

      - if: (!((matrix.java == 'semeru@25'))) && (!(contains(github.event.head_commit.message, 'full CI')))
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true '++ ${{ matrix.scala }}' '${{ matrix.ci }}'

      - if: (!((matrix.java == 'semeru@25'))) && (contains(github.event.head_commit.message, 'full CI'))
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true '++ ${{ matrix.scala }}' '${{ matrix.ci }}Full'

      - if: ((matrix.java == 'semeru@25'))
        shell: bash
        run: 'sbt -v -Dsbt.server.forcestart=true ''++ ${{ matrix.scala }}'' -J-Xgcpolicy:balanced ''${{ matrix.ci }}'''

      - if: (matrix.os == 'ubuntu-24.04-arm') && (matrix.java == 'temurin@25') && (matrix.scala == '2.13.18')
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true '++ ${{ matrix.scala }}' checkScalafix

      - if: (((matrix.os != 'windows-2025') && (matrix.os != 'windows-11-arm')) && ((matrix.java == 'temurin@21') ||(matrix.java == 'graalvm@21'))) && (contains(github.event.head_commit.message, 'stressLinchk'))
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true '++ ${{ matrix.scala }}' runLincheckTests

      - if: (((matrix.os == 'macos-15') || (matrix.os == 'ubuntu-24.04-arm') || (matrix.os == 'ubuntu-24.04')) && (matrix.java == 'temurin@25')) && (contains(github.event.head_commit.message, 'stressMcas'))
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true '++ ${{ matrix.scala }}' stressMcas/Jcstress/run

      - if: (((matrix.os == 'macos-15') || (matrix.os == 'ubuntu-24.04-arm') || (matrix.os == 'ubuntu-24.04')) && (matrix.java == 'temurin@25')) && (contains(github.event.head_commit.message, 'stressCore'))
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true '++ ${{ matrix.scala }}' stressCore/Jcstress/run

      - if: (((matrix.os == 'macos-15') || (matrix.os == 'ubuntu-24.04-arm') || (matrix.os == 'ubuntu-24.04')) && (matrix.java == 'temurin@25')) && (contains(github.event.head_commit.message, 'stressData'))
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true '++ ${{ matrix.scala }}' stressData/Jcstress/run

      - if: (((matrix.os == 'macos-15') || (matrix.os == 'ubuntu-24.04-arm') || (matrix.os == 'ubuntu-24.04')) && (matrix.java == 'temurin@25')) && (contains(github.event.head_commit.message, 'stressAsync'))
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true '++ ${{ matrix.scala }}' stressAsync/Jcstress/run

      - if: (((matrix.os == 'macos-15') || (matrix.os == 'ubuntu-24.04-arm') || (matrix.os == 'ubuntu-24.04')) && (matrix.java == 'temurin@25')) && (contains(github.event.head_commit.message, 'stressExperiments'))
        shell: bash
        run: sbt -v -Dsbt.server.forcestart=true '++ ${{ matrix.scala }}' stressExperiments/Jcstress/run

      - name: Upload JCStress results
        if: (success() || failure()) && (((matrix.os == 'macos-15') || (matrix.os == 'ubuntu-24.04-arm') || (matrix.os == 'ubuntu-24.04')) && (matrix.java == 'temurin@25')) && ((contains(github.event.head_commit.message, 'stressMcas') || contains(github.event.head_commit.message, 'stressCore') || contains(github.event.head_commit.message, 'stressData') || contains(github.event.head_commit.message, 'stressAsync') || contains(github.event.head_commit.message, 'stressExperiments'))) && (matrix.ci == 'ciJVM')
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: jcstress-results-${{ matrix.os }}-${{ matrix.scala }}-${{ matrix.java }}
          path: results/

      - name: ZIP Graal dumps
        if: (success() || failure()) && (matrix.os == 'ubuntu-24.04-arm') && (matrix.java == 'graalvm@25')
        shell: bash
        run: zip -r graal_dumps.zip . -i 'graal_dumps/*'

      - name: Upload Graal dumps
        if: (success() || failure()) && (matrix.os == 'ubuntu-24.04-arm') && (matrix.java == 'graalvm@25') && (matrix.ci == 'ciJVM')
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: graal-dumps-${{ matrix.os }}-${{ matrix.scala }}-${{ matrix.java }}
          path: graal_dumps.zip
          if-no-files-found: error

  dependency-submission:
    name: Submit Dependencies
    if: github.event.repository.fork == false && github.event_name != 'pull_request'
    strategy:
      matrix:
        os: [ubuntu-slim]
        java: [temurin@11]
    runs-on: ${{ matrix.os }}
    permissions:
      actions: none
      checks: none
      contents: write
      deployments: none
      id-token: none
      issues: none
      packages: none
      pages: none
      pull-requests: none
      repository-projects: none
      security-events: none
      statuses: none
    steps:
      - name: Ignore line ending differences in git
        if: contains(runner.os, 'windows')
        run: git config --global core.autocrlf false

      - name: Checkout current branch (full)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup sbt
        uses: sbt/setup-sbt@3e125ece5c3e5248e18da9ed8d2cce3d335ec8dd

      - name: Setup Java (temurin@11)
        id: setup-java-temurin-11
        if: matrix.java == 'temurin@11'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: temurin
          java-version: 11
          cache: sbt

      - name: sbt update
        if: matrix.java == 'temurin@11' && steps.setup-java-temurin-11.outputs.cache-hit == 'false'
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Setup Java (temurin@21)
        id: setup-java-temurin-21
        if: matrix.java == 'temurin@21'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: temurin
          java-version: 21
          cache: sbt

      - name: sbt update
        if: matrix.java == 'temurin@21' && steps.setup-java-temurin-21.outputs.cache-hit == 'false'
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Setup Java (temurin@25)
        id: setup-java-temurin-25
        if: matrix.java == 'temurin@25'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: temurin
          java-version: 25
          cache: sbt

      - name: sbt update
        if: matrix.java == 'temurin@25' && steps.setup-java-temurin-25.outputs.cache-hit == 'false'
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Setup Java (graalvm@21)
        id: setup-java-graalvm-21
        if: matrix.java == 'graalvm@21'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: graalvm
          java-version: 21
          cache: sbt

      - name: sbt update
        if: matrix.java == 'graalvm@21' && steps.setup-java-graalvm-21.outputs.cache-hit == 'false'
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Setup Java (graalvm@25)
        id: setup-java-graalvm-25
        if: matrix.java == 'graalvm@25'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: graalvm
          java-version: 25
          cache: sbt

      - name: sbt update
        if: matrix.java == 'graalvm@25' && steps.setup-java-graalvm-25.outputs.cache-hit == 'false'
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Setup Java (semeru@25)
        id: setup-java-semeru-25
        if: matrix.java == 'semeru@25'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165
        with:
          distribution: semeru
          java-version: 25
          cache: sbt

      - name: sbt update
        if: matrix.java == 'semeru@25' && steps.setup-java-semeru-25.outputs.cache-hit == 'false'
        run: sbt -v -Dsbt.server.forcestart=true +update

      - name: Submit Dependencies
        uses: scalacenter/sbt-dependency-submission@64084844d2b0a9b6c3765f33acde2fbe3f5ae7d3
        with:
          modules-ignore: choam-stress-data-slow_2.13 choam-stress-data-slow_3 choam-stress-rng_sjs1_2.13 choam-stress-rng_sjs1_3 choam-stress-rng_native0.5_2.13 choam-stress-rng_native0.5_3 choam_2.13 choam_3 choam-test-assert_2.13 choam-test-assert_3 choam-graal-ni-example_2.13 choam-graal-ni-example_3 choamjs_2.13 choamjs_3 choam-test-ext_native0.5_2.13 choam-test-ext_native0.5_3 choam-laws_2.13 choam-laws_3 choam-stress-mcas-slow_2.13 choam-stress-mcas-slow_3 choam-laws_native0.5_2.13 choam-laws_native0.5_3 choam-stress-experiments_2.13 choam-stress-experiments_3 choam-laws_sjs1_2.13 choam-laws_sjs1_3 choam-stress-linchk_2.13 choam-stress-linchk_3 choamjvm_2.13 choamjvm_3 choam-stress-mcas_2.13 choam-stress-mcas_3 choam-test-ext_2.13 choam-test-ext_3 choam-test-ext_sjs1_2.13 choam-test-ext_sjs1_3 choam-test-assert_native0.5_2.13 choam-test-assert_native0.5_3 choam-layout_2.13 choam-layout_3 choam-stress-core_2.13 choam-stress-core_3 choam-stress-data_2.13 choam-stress-data_3 choam-test-assert_sjs1_2.13 choam-test-assert_sjs1_3 choam-stress-async_2.13 choam-stress-async_3 choam-stress-rng_2.13 choam-stress-rng_3 choamnative_2.13 choamnative_3 choam-bench_2.13 choam-bench_3
          configs-ignore: test scala-tool scala-doc-tool test-internal
